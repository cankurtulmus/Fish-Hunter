<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bosphorus Fishing Forecast</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
  --ink:#0b0f1a; --ink2:#111827; --ink3:#1a2235;
  --border:rgba(255,255,255,0.07); --border2:rgba(255,255,255,0.12);
  --text:#f0f4ff; --muted:#4a6080; --muted2:#6b85a8;
  --accent:#00c4a8; --accent2:#0084ff; --gold:#ffb43a;
  --red:#ff4d6d; --purple:#a78bfa;
  --font:'Syne',sans-serif; --mono:'JetBrains Mono',monospace;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:var(--font);background:var(--ink);color:var(--text);overflow:hidden}
body{display:flex;flex-direction:column}

header{height:56px;background:rgba(11,15,26,.97);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 18px;gap:16px;z-index:200;flex-shrink:0}
.logo-mark{width:34px;height:34px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;box-shadow:0 0 18px rgba(0,196,168,.3);flex-shrink:0}
.brand-name{font-size:14px;font-weight:800;color:#fff}
.brand-sub{font-size:9px;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;font-family:var(--mono)}
.hdivider{width:1px;height:26px;background:var(--border2)}
.coord-lbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;font-family:var(--mono)}
.coord-val{font-family:var(--mono);font-size:12px;color:var(--accent);font-weight:600}
.hright{margin-left:auto;display:flex;align-items:center;gap:8px}
.live-pill{display:flex;align-items:center;gap:5px;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:20px;padding:3px 10px;font-size:10px;font-weight:700;color:#10b981;font-family:var(--mono)}
.live-dot{width:5px;height:5px;background:#10b981;border-radius:50%;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.btn-story{background:transparent;border:1px solid var(--border2);color:var(--muted2);border-radius:7px;padding:4px 12px;font-size:11px;font-weight:700;font-family:var(--font);cursor:pointer;transition:all .2s}
.btn-story:hover{border-color:var(--accent);color:var(--accent)}

.layout{display:flex;flex:1;overflow:hidden}

/* MAP */
.map-area{flex:1;position:relative}
#gmap{width:100%;height:100%;z-index:1}

/* Leaflet overrides */
.leaflet-container{background:#0b1220!important}
.leaflet-control-zoom{border:1px solid rgba(255,255,255,0.12)!important;box-shadow:none!important}
.leaflet-control-zoom a{background:rgba(17,24,39,.95)!important;color:#6b85a8!important;border-bottom:1px solid rgba(255,255,255,0.07)!important;font-size:16px!important;line-height:26px!important}
.leaflet-control-zoom a:hover{color:#f0f4ff!important;background:rgba(26,34,53,.95)!important}
.leaflet-popup-content-wrapper{background:rgba(17,24,39,.97)!important;border:1px solid rgba(255,255,255,0.12)!important;border-radius:12px!important;box-shadow:0 20px 40px rgba(0,0,0,.6)!important;color:#f0f4ff!important}
.leaflet-popup-tip{background:rgba(17,24,39,.97)!important}
.leaflet-popup-close-button{color:#4a6080!important;font-size:16px!important;padding:6px!important}
.leaflet-popup-close-button:hover{color:#f0f4ff!important}
.leaflet-control-attribution{background:rgba(11,15,26,.7)!important;color:#4a6080!important;font-size:9px!important}
.leaflet-control-attribution a{color:#4a7fa8!important}
.map-badge{position:absolute;background:rgba(11,15,26,.9);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:9px 13px;font-family:var(--mono);font-size:11px;z-index:500}
#badge-time{top:14px;left:14px}
#badge-weather{top:80px;left:14px}
.mb-lbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:3px}
.mb-val{color:var(--text);font-weight:600}

/* PANEL */
.panel{width:340px;flex-shrink:0;background:var(--ink2);border-left:1px solid var(--border);overflow-y:auto;scrollbar-width:thin;scrollbar-color:#1e3050 transparent}
.pb{padding:16px 18px;border-bottom:1px solid var(--border)}
.blbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.15em;color:var(--muted);margin-bottom:12px;font-family:var(--mono);display:flex;align-items:center;gap:8px}
.blbl::after{content:'';flex:1;height:1px;background:var(--border)}

.time-now{font-size:20px;font-weight:800;color:#fff;margin-bottom:10px}
.time-now span{color:var(--accent)}
.tscroll{display:flex;gap:5px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px}
.tscroll::-webkit-scrollbar{display:none}
.tchip{flex-shrink:0;width:58px;padding:7px 4px;border-radius:9px;border:1px solid var(--border);background:var(--ink3);cursor:pointer;text-align:center;transition:all .15s}
.tchip:hover{border-color:var(--accent2)}
.tchip.active{background:rgba(0,132,255,.15);border-color:var(--accent2);box-shadow:0 0 12px rgba(0,132,255,.2)}
.tc-pct{font-size:14px;font-weight:800;display:block;font-family:var(--mono)}
.tchip.active .tc-pct{color:#60b4ff}
.tc-hr{font-size:9px;color:var(--muted);display:block;margin-top:2px;font-family:var(--mono)}

.sol-win{background:linear-gradient(135deg,rgba(167,139,250,.1),rgba(139,92,246,.05));border:1px solid rgba(167,139,250,.25);border-radius:12px;padding:13px;display:flex;align-items:center;gap:12px;position:relative;overflow:hidden}
.sol-win::before{content:'';position:absolute;top:-20px;right:-20px;width:70px;height:70px;border-radius:50%;background:radial-gradient(circle,rgba(167,139,250,.15),transparent)}
.sol-badge{font-size:26px;font-weight:800;color:var(--purple);font-family:var(--mono);letter-spacing:-2px;line-height:1}
.sol-info{flex:1}
.sol-title{font-size:12px;font-weight:700;color:var(--purple)}
.sol-sub{font-size:10px;color:rgba(167,139,250,.7);margin-top:2px}
.sol-num{font-size:24px;font-weight:800;color:var(--purple);font-family:var(--mono);line-height:1;text-align:right}
.sol-unit{font-size:9px;color:rgba(167,139,250,.5);font-family:var(--mono);text-align:right}

.score-layout{display:flex;align-items:center;gap:16px}
.score-ring{position:relative;width:84px;height:84px;flex-shrink:0}
.score-svg{width:84px;height:84px;transform:rotate(-90deg)}
.score-track{fill:none;stroke:rgba(255,255,255,.06);stroke-width:7}
.score-fill{fill:none;stroke-width:7;stroke-linecap:round;transition:stroke-dasharray .8s cubic-bezier(.4,0,.2,1)}
.score-text{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.score-num{font-size:19px;font-weight:800;font-family:var(--mono);line-height:1}
.score-pct-s{font-size:8px;color:var(--muted);font-family:var(--mono)}
.score-grade{font-size:15px;font-weight:800;margin-bottom:2px}
.score-desc{font-size:11px;color:var(--muted2)}

.metrics{display:flex;flex-direction:column;gap:9px;margin-top:13px}
.mrow{display:flex;align-items:center;gap:9px}
.micon{font-size:13px;width:18px;text-align:center}
.mname{font-size:11px;color:var(--muted2);flex:1}
.mtrack{width:66px;height:3px;background:rgba(255,255,255,.05);border-radius:2px;overflow:hidden}
.mbar{height:100%;border-radius:2px;transition:width .6s}
.mval{font-size:11px;font-weight:600;font-family:var(--mono);min-width:66px;text-align:right;color:var(--text)}

.sol-bar{height:4px;background:rgba(255,255,255,.05);border-radius:2px;margin:8px 0 12px;overflow:hidden}
.sol-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--gold),var(--red));border-radius:2px;transition:width 1s}
.sol-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.sw-card{background:var(--ink3);border:1px solid var(--border);border-radius:8px;padding:9px 11px;display:flex;gap:7px;align-items:center}
.sw-card.maj{border-color:rgba(167,139,250,.3);background:rgba(167,139,250,.05)}
.sw-card.min{border-color:rgba(96,165,250,.2);background:rgba(96,165,250,.03)}
.sw-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.sw-card.maj .sw-dot{background:var(--purple);box-shadow:0 0 5px var(--purple)}
.sw-card.min .sw-dot{background:var(--accent2)}
.sw-type{font-size:8px;font-family:var(--mono);font-weight:700;text-transform:uppercase;letter-spacing:.1em}
.sw-card.maj .sw-type{color:var(--purple)}
.sw-card.min .sw-type{color:#60a5fa}
.sw-time{font-size:13px;font-weight:700;font-family:var(--mono);color:var(--text)}
.sw-lbl{font-size:9px;color:var(--muted)}

.fc-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:5px}
.fc-card{background:var(--ink3);border:1px solid var(--border);border-radius:9px;padding:9px 5px;text-align:center;cursor:pointer;transition:all .2s}
.fc-card:hover{border-color:rgba(255,255,255,.2);transform:translateY(-1px)}
.fc-card.peak{border-color:rgba(0,196,168,.4);background:rgba(0,196,168,.05)}
.fc-hr{font-size:9px;color:var(--muted);font-family:var(--mono)}
.fc-score{font-size:16px;font-weight:800;font-family:var(--mono);margin:2px 0}
.fc-lbl{font-size:8px;color:var(--muted)}
.fc-peak{font-size:8px;color:var(--accent);margin-top:2px;font-weight:700}

.loc-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.btn-add{background:rgba(0,196,168,.1);border:1px solid rgba(0,196,168,.3);color:var(--accent);border-radius:7px;padding:4px 11px;font-size:11px;font-weight:700;font-family:var(--font);cursor:pointer;transition:all .2s}
.btn-add:hover{background:rgba(0,196,168,.2)}
.loc-item{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:all .15s}
.loc-item:last-child{border-bottom:none}
.loc-item:hover{background:rgba(255,255,255,.02);margin:0 -18px;padding:9px 18px}
.loc-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.loc-name{font-size:12px;font-weight:600;flex:1;color:var(--text)}
.loc-coords{font-size:9px;color:var(--muted);font-family:var(--mono)}
.loc-score{font-size:15px;font-weight:800;font-family:var(--mono)}
.loc-del{opacity:0;background:rgba(255,77,109,.15);border:none;color:var(--red);border-radius:5px;width:22px;height:22px;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.loc-item:hover .loc-del{opacity:1}

/* custom marker popup */
.gm-style .gm-style-iw-c{background:var(--ink2)!important;border:1px solid var(--border2)!important;border-radius:12px!important;box-shadow:0 20px 40px rgba(0,0,0,.5)!important;padding:0!important}
.gm-style .gm-style-iw-d{overflow:hidden!important;padding:14px!important}
.gm-style .gm-style-iw-tc::after{background:var(--ink2)!important}
.gm-style-iw-ch{display:none!important}
.gm-ui-hover-effect{display:none!important}

.popup-inner{font-family:var(--font);min-width:180px}
.popup-name{font-size:14px;font-weight:800;color:#fff;margin-bottom:6px}
.popup-score{font-size:30px;font-weight:800;font-family:var(--mono);line-height:1}
.popup-grade{font-size:12px;font-weight:700;margin-bottom:6px}
.popup-coord{font-size:10px;color:var(--muted);font-family:var(--mono)}

.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);z-index:999;align-items:center;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:var(--ink2);border:1px solid var(--border2);border-radius:15px;padding:26px;width:360px;box-shadow:0 40px 80px rgba(0,0,0,.5);animation:mIn .2s ease}
@keyframes mIn{from{transform:scale(.95) translateY(8px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
.mtitle{font-size:17px;font-weight:800;margin-bottom:5px}
.msub{font-size:11px;color:var(--muted2);margin-bottom:20px}
.flbl{font-size:10px;color:var(--muted2);text-transform:uppercase;letter-spacing:.1em;font-family:var(--mono);font-weight:700;display:block;margin-bottom:5px}
.finput{width:100%;background:var(--ink3);border:1px solid var(--border2);border-radius:8px;padding:9px 13px;font-family:var(--font);font-size:13px;color:var(--text);outline:none;transition:border-color .15s;margin-bottom:13px}
.finput:focus{border-color:var(--accent)}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.frow .finput{margin-bottom:0}
.fsel{width:100%;background:var(--ink3);border:1px solid var(--border2);border-radius:8px;padding:9px 13px;font-family:var(--font);font-size:13px;color:var(--text);outline:none;cursor:pointer;margin-top:13px}
.fsel option{background:var(--ink2)}
.mstatus{font-size:10px;color:var(--accent);font-family:var(--mono);min-height:14px;margin-top:8px}
.mbtns{display:flex;gap:9px;margin-top:20px}
.btn-cancel{flex:1;background:var(--ink3);border:1px solid var(--border2);color:var(--muted2);border-radius:9px;padding:10px;font-size:12px;font-weight:700;font-family:var(--font);cursor:pointer}
.btn-save{flex:1;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#fff;border-radius:9px;padding:10px;font-size:12px;font-weight:700;font-family:var(--font);cursor:pointer}
.btn-save:hover{opacity:.9}

.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--ink2);border:1px solid var(--border2);border-radius:9px;padding:9px 18px;font-size:12px;font-weight:600;z-index:9999;transition:transform .3s;pointer-events:none}
.toast.show{transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>

<header>
  <div class="logo-mark">ğŸ£</div>
  <div>
    <div class="brand-name">Bosphorus Fishing Forecast</div>
    <div class="brand-sub">Istanbul Â· Real-time Analysis</div>
  </div>
  <div class="hdivider"></div>
  <div>
    <div class="coord-lbl">SeÃ§ili Konum</div>
    <div class="coord-val" id="coordDisplay">41.1540Â° N, 29.0377Â° E</div>
  </div>
  <div class="hright">
    <button class="btn-story">ğŸ“· Story</button>
    <div class="live-pill"><div class="live-dot"></div>CANLI</div>
  </div>
</header>

<div class="layout">
  <div class="map-area">
    <div id="gmap"></div>
    <div class="map-badge" id="badge-time"><div class="mb-lbl">Saat</div><div class="mb-val" id="mapTime">--:--:--</div></div>
    <div class="map-badge" id="badge-weather"><div class="mb-lbl">Hava Durumu</div><div class="mb-val" id="mapWeather">YÃ¼kleniyor...</div></div>
  </div>

  <div class="panel">
    <div class="pb">
      <div class="blbl">ğŸ• Zaman SeÃ§ici</div>
      <div class="time-now">Åu an â€” <span id="nowHour">--:--</span></div>
      <div class="tscroll" id="timeChips"></div>
    </div>
    <div class="pb">
      <div class="sol-win" id="solWin">
        <div class="sol-badge" id="solBadge">MAJ</div>
        <div class="sol-info">
          <div class="sol-title" id="solTitle">Major Pencere Aktif</div>
          <div class="sol-sub" id="solSub">Ay Zenitta â€” Aktivite artmÄ±ÅŸ</div>
        </div>
        <div>
          <div class="sol-num" id="solTimer">â€”</div>
          <div class="sol-unit">dk kaldÄ±</div>
        </div>
      </div>
    </div>
    <div class="pb">
      <div class="blbl">ğŸ¯ BalÄ±k Tutma OlasÄ±lÄ±ÄŸÄ±</div>
      <div class="score-layout">
        <div class="score-ring">
          <svg class="score-svg" viewBox="0 0 84 84">
            <circle class="score-track" cx="42" cy="42" r="35"/>
            <circle class="score-fill" id="scoreArc" cx="42" cy="42" r="35" stroke="#00c4a8" stroke-dasharray="0 220"/>
          </svg>
          <div class="score-text">
            <div class="score-num" id="scoreNum" style="color:var(--accent)">â€”</div>
            <div class="score-pct-s">%</div>
          </div>
        </div>
        <div>
          <div class="score-grade" id="scoreGrade" style="color:var(--accent)">YÃ¼kleniyor</div>
          <div class="score-desc">Avlanma koÅŸullarÄ±</div>
        </div>
      </div>
      <div class="metrics" id="metricsGrid"></div>
    </div>
    <div class="pb">
      <div class="blbl">ğŸŒ™ Solunar Pencereler</div>
      <div class="sol-bar"><div class="sol-fill" id="solBarFill" style="width:0%"></div></div>
      <div class="sol-grid" id="solGrid"></div>
    </div>
    <div class="pb">
      <div class="blbl">ğŸ“Š 24 Saatlik Tahmin</div>
      <div class="fc-grid" id="fcGrid"></div>
    </div>
    <div class="pb">
      <div class="loc-hdr">
        <div class="blbl" style="margin-bottom:0">ğŸ“ Analiz NoktalarÄ±</div>
        <button class="btn-add" onclick="openModal()">ï¼‹ Ekle</button>
      </div>
      <div id="locList"></div>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal">
  <div class="modal">
    <div class="mtitle">Yeni Lokasyon Ekle</div>
    <div class="msub">Haritaya tÄ±klayarak veya koordinat girerek ekleyin.</div>
    <label class="flbl">Lokasyon AdÄ±</label>
    <input class="finput" id="mName" type="text" placeholder="Ã¶rn. Bebek Koyu...">
    <div class="frow">
      <div><label class="flbl">Enlem (Lat)</label><input class="finput" id="mLat" type="number" step="0.0001" placeholder="41.0794"></div>
      <div><label class="flbl">Boylam (Lng)</label><input class="finput" id="mLng" type="number" step="0.0001" placeholder="29.0400"></div>
    </div>
    <label class="flbl" style="margin-top:4px">Tip</label>
    <select class="fsel" id="mType">
      <option value="shore">ğŸ– KÄ±yÄ±</option>
      <option value="pier">ğŸš¢ Ä°skele</option>
      <option value="bay">âš“ Koy</option>
      <option value="bridge">ğŸŒ‰ KÃ¶prÃ¼ AltÄ±</option>
      <option value="rock">ğŸª¨ KayalÄ±k</option>
      <option value="beach">ğŸ Plaj</option>
    </select>
    <div class="mstatus" id="mStatus">Haritaya tÄ±klayarak koordinat seÃ§ebilirsiniz.</div>
    <div class="mbtns">
      <button class="btn-cancel" onclick="closeModal()">Ä°ptal</button>
      <button class="btn-save" onclick="saveLoc()">Kaydet</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Google Maps API â€” kendi API key'ini buraya yaz -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOLUNAR ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Sol={
  r:d=>d*Math.PI/180,
  phase(dt){const k=new Date(2000,0,6,18,14,0),c=29.53058867;return(((dt-k)/86400000%c)+c)%c/c;},
  moonLon(dt){
    const d=(dt-new Date(2000,0,1,12))/86400000;
    const L=(218.316+13.176396*d)%360,M=(134.963+13.064993*d)%360;
    return(L+6.289*Math.sin(this.r(M))+360)%360;
  },
  windows(dt,lng){
    const ml=this.moonLon(dt),ls=((ml+lng)/15+24)%24;
    const oh=ls%24,uf=(oh+12)%24,m1=(oh+6.2)%24,m2=(oh+18.2)%24;
    const f=h=>`${String(Math.floor(h)).padStart(2,'0')}:${String(Math.floor((h%1)*60)).padStart(2,'0')}`;
    return{
      major:[{time:f(oh),label:'Ay Zenitta',type:'maj'},{time:f(uf),label:'Ay Nadirde',type:'maj'}],
      minor:[{time:f(m1),label:'Ay DoÄŸuÅŸu',type:'min'},{time:f(m2),label:'Ay BatÄ±ÅŸÄ±',type:'min'}]
    };
  },
  score(dt){const p=this.phase(dt),d=Math.min(p,1-p)*2;return Math.round(65+(1-d)*35);},
  next(dt,lng){
    const w=this.windows(dt,lng),nm=dt.getHours()*60+dt.getMinutes();
    let best=null,md=9999,isMaj=true;
    [...w.major,...w.minor].forEach((x,i)=>{
      const[hh,mm]=x.time.split(':').map(Number);let diff=hh*60+mm-nm;
      if(diff<0)diff+=1440;if(diff<md){md=diff;best=x;isMaj=i<2;}
    });
    return{w:best,mins:Math.round(md),isMaj};
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCORE ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SE={
  calc(p){
    const tS=p.wt>=6&&p.wt<=18?100-Math.abs(p.wt-12)*4:30;
    const wS=p.wind<5?90:p.wind<12?80:p.wind<20?55:p.wind<30?30:10;
    const wvS=p.wave<.15?95:p.wave<.3?80:p.wave<.6?55:p.wave<1?30:10;
    const pS=p.trend==='rising'?85:p.trend==='stable'?72:40;
    const tAS=[5,6,7,17,18,19].includes(p.hour)?95:[4,8,9,16,20,21].includes(p.hour)?75:50;
    return Math.min(99,Math.max(15,Math.round(tS*.18+wS*.18+wvS*.15+pS*.14+p.sol*.22+p.sr*.06+tAS*.07)));
  },
  grade(s){
    if(s>=80)return{l:'MÃ¼kemmel',c:'#10b981'};
    if(s>=65)return{l:'Ã‡ok Ä°yi',c:'#ffb43a'};
    if(s>=50)return{l:'Ä°yi',c:'#0084ff'};
    if(s>=35)return{l:'Orta',c:'#6b7280'};
    return{l:'ZayÄ±f',c:'#ff4d6d'};
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA STORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORE='bff_locs_v3';
const DEFAULT_LOCS=[
  {id:1,name:'Beykoz Sahili',lat:41.1217,lng:29.0967,type:'shore'},
  {id:2,name:'Anadolu HisarÄ±',lat:41.0892,lng:29.0583,type:'bridge'},
  {id:3,name:'Rumeli HisarÄ±',lat:41.0862,lng:29.0547,type:'bridge'},
  {id:4,name:'Bebek Koyu',lat:41.0794,lng:29.0400,type:'bay'},
  {id:5,name:'Tarabya',lat:41.1270,lng:29.0617,type:'shore'},
  {id:6,name:'SarÄ±yer',lat:41.1648,lng:29.0518,type:'pier'},
  {id:7,name:'Kilyos',lat:41.2478,lng:28.9738,type:'beach'},
  {id:8,name:'ÃœskÃ¼dar',lat:41.0225,lng:29.0133,type:'shore'},
  {id:9,name:'KadÄ±kÃ¶y',lat:40.9905,lng:29.0227,type:'pier'},
  {id:10,name:'Ã‡engelkÃ¶y',lat:41.0542,lng:29.0642,type:'bay'},
];
function loadLocs(){try{return JSON.parse(localStorage.getItem(STORE))||DEFAULT_LOCS;}catch{return DEFAULT_LOCS;}}
function saveL(){localStorage.setItem(STORE,JSON.stringify(locations));}

let locations=loadLocs();
let nextId=Math.max(...locations.map(l=>l.id))+1;
let selectedHour=new Date().getHours();
let selectedLoc=locations[0];
let weatherCache={};
let addMode=false;
let timerVal=0;
let leafMap=null;
let leafMarkers=[];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEATHER (Open-Meteo)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchWeather(lat,lng){
  const k=`${lat.toFixed(1)}_${lng.toFixed(1)}`;
  if(weatherCache[k])return weatherCache[k];
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=temperature_2m,windspeed_10m,surface_pressure&daily=sunrise,sunset&timezone=Europe/Istanbul&forecast_days=1&wind_speed_unit=kmh`);
    const d=await r.json();
    const pr=d.hourly.surface_pressure;
    const res={
      temps:d.hourly.temperature_2m,winds:d.hourly.windspeed_10m,pressures:pr,
      trends:pr.map((p,i)=>i<3?'stable':p>pr[i-3]+1?'rising':p<pr[i-3]-1?'falling':'stable'),
      sunrise:d.daily?.sunrise?.[0],sunset:d.daily?.sunset?.[0]
    };
    weatherCache[k]=res;return res;
  }catch{
    return{temps:Array(24).fill(12),winds:Array(24).fill(8),pressures:Array(24).fill(1018),trends:Array(24).fill('stable')};
  }
}

function getMarine(lat,lng,hour){
  const m=new Date().getMonth();
  const bt=[7,7,8,10,13,17,21,22,20,17,13,9][m];
  return{wt:bt+Math.sin(hour/24*Math.PI)*.4,wave:Math.max(.02,.07+Math.random()*.09)};
}

function sunR(hour,sr,ss){
  const s=sr?new Date(sr).getHours()+new Date(sr).getMinutes()/60:6;
  const e=ss?new Date(ss).getHours()+new Date(ss).getMinutes()/60:20;
  if(hour>=s-.5&&hour<=s+1.5)return 90;
  if(hour>=e-1&&hour<=e+.5)return 85;
  if(hour>=s+1.5&&hour<=s+3)return 65;
  if(hour>=e-2&&hour<e-1)return 60;
  return 18;
}

async function buildScores(loc,wd){
  const ss=Sol.score(new Date());
  return Array.from({length:24},(_,h)=>{
    const m=getMarine(loc.lat,loc.lng,h);
    return SE.calc({wt:m.wt,wind:wd.winds[h],wave:m.wave,trend:wd.trends[h],
      sol:ss+(Math.random()-.5)*4,sr:sunR(h,wd.sunrise,wd.sunset),hour:h});
  });
}

function s2c(s){
  if(s>=80)return'#10b981';if(s>=65)return'#ffb43a';
  if(s>=50)return'#0084ff';if(s>=35)return'#6b7280';return'#ff4d6d';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEAFLET MAP (OpenStreetMap Satellite)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initLeafMap(){
  leafMap = L.map('gmap', {
    center: [41.05, 29.03],
    zoom: 11,
    zoomControl: true,
    attributionControl: true
  });

  // ESRI Satellite tile â€” Ã¼cretsiz, key yok
  L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { attribution: 'Â© Esri, Maxar, Earthstar Geographics', maxZoom: 19 }
  ).addTo(leafMap);

  // Yer adlarÄ± katmanÄ± (satellite Ã¼stÃ¼ne)
  L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',
    { attribution: '', maxZoom: 19, opacity: 0.7 }
  ).addTo(leafMap);

  leafMap.on('click', e => {
    if(addMode){
      document.getElementById('mLat').value = e.latlng.lat.toFixed(5);
      document.getElementById('mLng').value = e.latlng.lng.toFixed(5);
      document.getElementById('mStatus').textContent = `âœ“ SeÃ§ildi: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
      return;
    }
    document.getElementById('coordDisplay').textContent =
      `${e.latlng.lat.toFixed(4)}Â° N, ${e.latlng.lng.toFixed(4)}Â° E`;
  });

  updateAll();
}

function createLeafIcon(score, color, isSelected){
  const size = isSelected ? 48 : 40;
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size+10}" viewBox="0 0 ${size} ${size+10}">
    <defs>
      <filter id="g${score}">
        <feGaussianBlur stdDeviation="2.5" result="b"/>
        <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <circle cx="${size/2}" cy="${size/2}" r="${size/2-2}" fill="${color}"
      filter="url(#g${score})" stroke="white" stroke-width="${isSelected?2.5:1.8}" opacity="0.95"/>
    <polygon points="${size/2-6},${size/2+8} ${size/2},${size+10} ${size/2+6},${size/2+8}"
      fill="${color}" opacity="0.9"/>
    <text x="${size/2}" y="${size/2+1}" text-anchor="middle" dominant-baseline="middle"
      font-family="JetBrains Mono,monospace" font-weight="800"
      font-size="${isSelected?12:10}" fill="white">${score}%</text>
  </svg>`;
  return L.divIcon({
    html: svg,
    className: '',
    iconSize: [size, size+10],
    iconAnchor: [size/2, size+10],
    popupAnchor: [0, -(size+10)]
  });
}

async function renderMarkers(){
  leafMarkers.forEach(m => m.remove());
  leafMarkers = [];
  if(!leafMap) return;

  for(const loc of locations){
    const wd = await fetchWeather(loc.lat, loc.lng);
    const sc = await buildScores(loc, wd);
    const s = sc[selectedHour];
    const g = SE.grade(s);
    const isSel = (loc.id === selectedLoc.id);

    const marker = L.marker([loc.lat, loc.lng], {
      icon: createLeafIcon(s, g.c, isSel),
      zIndexOffset: isSel ? 1000 : 0
    }).addTo(leafMap);

    marker.bindPopup(`
      <div style="font-family:'Syne',sans-serif;min-width:180px;padding:4px">
        <div style="font-weight:800;font-size:15px;margin-bottom:6px;color:#f0f4ff">${loc.name}</div>
        <div style="font-size:30px;font-weight:800;font-family:'JetBrains Mono',monospace;color:${g.c};line-height:1">${s}%</div>
        <div style="font-size:12px;font-weight:700;color:${g.c};margin:4px 0 8px">${g.l}</div>
        <div style="font-size:10px;color:#4a6080;font-family:'JetBrains Mono',monospace">${loc.lat.toFixed(4)}Â°N, ${loc.lng.toFixed(4)}Â°E</div>
      </div>`
    );

    marker.on('click', () => selectLoc(loc.id));
    leafMarkers.push(marker);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChips(scores){
  const el=document.getElementById('timeChips');
  el.innerHTML='';
  scores.forEach((s,i)=>{
    const c=s2c(s);
    const chip=document.createElement('div');
    chip.className=`tchip${i===selectedHour?' active':''}`;
    chip.innerHTML=`<span class="tc-pct" style="color:${i===selectedHour?'#60b4ff':c}">${s}%</span><span class="tc-hr">${String(i).padStart(2,'0')}:00</span>`;
    chip.onclick=()=>{selectedHour=i;updateAll();};
    el.appendChild(chip);
  });
  el.querySelector('.active')?.scrollIntoView({block:'nearest',inline:'center',behavior:'smooth'});
}

function renderScore(s,wd,marine){
  const g=SE.grade(s);
  const circ=2*Math.PI*35;
  const fill=(s/100)*circ;
  const arc=document.getElementById('scoreArc');
  arc.style.strokeDasharray=`${fill} ${circ}`;
  arc.style.stroke=g.c;
  document.getElementById('scoreNum').textContent=s;
  document.getElementById('scoreNum').style.color=g.c;
  document.getElementById('scoreGrade').textContent=g.l;
  document.getElementById('scoreGrade').style.color=g.c;
  const ss=Sol.score(new Date()),sr=sunR(selectedHour,wd.sunrise,wd.sunset);
  const rows=[
    {i:'ğŸ’§',n:'Su SÄ±caklÄ±ÄŸÄ±',v:`${marine.wt.toFixed(1)}Â°C`,p:Math.min(100,(marine.wt/20)*100),c:'#3b82f6'},
    {i:'ğŸ”µ',n:'BasÄ±nÃ§',v:`${(wd.pressures[selectedHour]||1020).toFixed(0)} hPa`,p:((wd.pressures[selectedHour]||1020)-980)/60*100,c:'#14b8a6'},
    {i:'ğŸ’¨',n:'RÃ¼zgar',v:`${(wd.winds[selectedHour]||5).toFixed(0)} km/h`,p:Math.max(5,100-(wd.winds[selectedHour]||5)*3.5),c:'#f59e0b'},
    {i:'ğŸŒŠ',n:'Dalga',v:`${marine.wave.toFixed(2)} m`,p:Math.max(5,100-marine.wave*100),c:'#6366f1'},
    {i:'ğŸŒ™',n:'Solunar',v:`${ss}%`,p:ss,c:'#a78bfa'},
    {i:'â˜€ï¸',n:'GÃ¼n Ritmi',v:`${sr}%`,p:sr,c:'#f97316'},
  ];
  document.getElementById('metricsGrid').innerHTML=rows.map(r=>`
    <div class="mrow">
      <div class="micon">${r.i}</div><div class="mname">${r.n}</div>
      <div class="mtrack"><div class="mbar" style="width:${Math.min(100,Math.max(3,r.p))}%;background:${r.c}"></div></div>
      <div class="mval">${r.v}</div>
    </div>`).join('');
}

function renderSolunar(lng){
  const dt=new Date(),w=Sol.windows(dt,lng),nx=Sol.next(dt,lng),sc=Sol.score(dt);
  timerVal=nx.mins;
  document.getElementById('solBadge').textContent=nx.isMaj?'MAJ':'MÄ°N';
  document.getElementById('solTitle').textContent=nx.isMaj?'Major Pencere Aktif':'Minor Pencere';
  document.getElementById('solSub').textContent=`${nx.w.label} â€” Aktivite artmÄ±ÅŸ`;
  document.getElementById('solTimer').textContent=nx.mins;
  document.getElementById('solBarFill').style.width=sc+'%';
  const all=[...w.major,...w.minor];
  document.getElementById('solGrid').innerHTML=all.map(x=>`
    <div class="sw-card ${x.type}">
      <div class="sw-dot"></div>
      <div><div class="sw-type">${x.type==='maj'?'MAJOR':'MINOR'}</div>
      <div class="sw-time">${x.time}</div><div class="sw-lbl">${x.label}</div></div>
    </div>`).join('');
}

function renderForecast(scores){
  const peak=Math.max(...scores),hrs=[4,6,9,12,15,18,20,22];
  document.getElementById('fcGrid').innerHTML=hrs.map(h=>{
    const s=scores[h],g=SE.grade(s),ip=s===peak;
    return`<div class="fc-card${ip?' peak':''}" onclick="selectedHour=${h};updateAll()">
      <div class="fc-hr">${String(h).padStart(2,'0')}:00</div>
      <div class="fc-score" style="color:${g.c}">${s}%</div>
      <div class="fc-lbl">${g.l}</div>${ip?'<div class="fc-peak">â˜… EN Ä°YÄ°</div>':''}
    </div>`;}).join('');
}

async function renderLocList(){
  const data=await Promise.all(locations.map(async loc=>{
    const wd=await fetchWeather(loc.lat,loc.lng);
    const sc=await buildScores(loc,wd);
    return{...loc,score:sc[selectedHour]};
  }));
  data.sort((a,b)=>b.score-a.score);
  const icons={shore:'ğŸ–',pier:'ğŸš¢',bay:'âš“',bridge:'ğŸŒ‰',rock:'ğŸª¨',beach:'ğŸ'};
  document.getElementById('locList').innerHTML=data.map(loc=>{
    const c=s2c(loc.score);
    return`<div class="loc-item" onclick="selectLoc(${loc.id})">
      <div class="loc-dot" style="background:${c};box-shadow:0 0 6px ${c}"></div>
      <div style="flex:1"><div class="loc-name">${icons[loc.type]||'ğŸ“'} ${loc.name}</div>
      <div class="loc-coords">${loc.lat.toFixed(4)}N ${loc.lng.toFixed(4)}E</div></div>
      <div class="loc-score" style="color:${c}">${loc.score}%</div>
      <button class="loc-del" onclick="event.stopPropagation();delLoc(${loc.id})">âœ•</button>
    </div>`;}).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function updateAll(){
  document.getElementById('nowHour').textContent=`${String(selectedHour).padStart(2,'0')}:00`;
  const wd=await fetchWeather(selectedLoc.lat,selectedLoc.lng);
  const scores=await buildScores(selectedLoc,wd);
  const marine=getMarine(selectedLoc.lat,selectedLoc.lng,selectedHour);
  renderChips(scores);
  renderScore(scores[selectedHour],wd,marine);
  renderSolunar(selectedLoc.lng);
  renderForecast(scores);
  await renderLocList();
  await renderMarkers();
  document.getElementById('mapWeather').innerHTML=
    `ğŸŒ¡ ${(wd.temps[selectedHour]||0).toFixed(1)}Â°C &nbsp;ğŸ’¨ ${(wd.winds[selectedHour]||0).toFixed(0)} km/h &nbsp;ğŸ”µ ${(wd.pressures[selectedHour]||0).toFixed(0)} hPa`;
}

function selectLoc(id){
  const loc=locations.find(l=>l.id===id)||locations[0];
  selectedLoc=loc;
  document.getElementById('coordDisplay').textContent=`${loc.lat.toFixed(4)}Â° N, ${loc.lng.toFixed(4)}Â° E`;
  if(leafMap) leafMap.panTo([loc.lat, loc.lng]);
  updateAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(){
  document.getElementById('modal').classList.add('open');
  document.getElementById('mName').value='';
  document.getElementById('mLat').value='';
  document.getElementById('mLng').value='';
  document.getElementById('mStatus').textContent='Haritaya tÄ±klayarak koordinat seÃ§ebilirsiniz.';
  addMode=true;
}
function closeModal(){document.getElementById('modal').classList.remove('open');addMode=false;}
function saveLoc(){
  const name=document.getElementById('mName').value.trim();
  const lat=parseFloat(document.getElementById('mLat').value);
  const lng=parseFloat(document.getElementById('mLng').value);
  const type=document.getElementById('mType').value;
  if(!name){document.getElementById('mStatus').textContent='âš  Lokasyon adÄ± gerekli.';return;}
  if(isNaN(lat)||isNaN(lng)){document.getElementById('mStatus').textContent='âš  GeÃ§erli koordinat girin.';return;}
  if(lat<39||lat>43||lng<27||lng>32){document.getElementById('mStatus').textContent='âš  Ä°stanbul dÄ±ÅŸÄ± koordinat.';return;}
  locations.push({id:nextId++,name,lat,lng,type});
  saveL();closeModal();showToast(`âœ“ "${name}" eklendi`);updateAll();
}
function delLoc(id){
  if(locations.length<=1){showToast('âš  En az 1 lokasyon gerekli');return;}
  const loc=locations.find(l=>l.id===id);
  locations=locations.filter(l=>l.id!==id);
  saveL();if(selectedLoc.id===id)selectedLoc=locations[0];
  showToast(`"${loc?.name}" silindi`);updateAll();
}
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Saat: her saniye gÃ¼ncelle
setInterval(()=>{
  document.getElementById('mapTime').textContent=
    new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
},1000);

// Solunar geri sayÄ±m: her 60 saniyede 1 dakika azalt
setInterval(()=>{
  if(timerVal>0){
    timerVal--;
    document.getElementById('solTimer').textContent=timerVal;
  }
},60000);
setInterval(()=>{weatherCache={};updateAll();},600000);
</script>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  selectedHour = new Date().getHours();
  selectedLoc = locations[0];
  initLeafMap();
});

</body>
</html>
